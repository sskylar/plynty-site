<script>
  document.domain = 'localhost';
  var url = window.location.href;
  var accessToken = url.substring(url.lastIndexOf('?') + 1);
  $("#verify_token_form").hide(); // Hide verify token initially
  $("#password_change").hide(); // Hide verify token initially
  $("#email_error").hide();
  $("#success").hide();
  var myInfo = {
    forceSms: true
  };

  $("#verify_email_form").submit(function (event) {
    myInfo.email = document.getElementById("email").value;
    var request = $.ajax({
      url: "https://dev.plynty.com/api/users/requestSms",
      data: myInfo,
      contentType: "application/json; charset=utf-8"
    });

    request.done(function (msg) {
      if (!JSON.stringify(msg.response.error)) {
        var authyOk = JSON.stringify(msg.response.authyOk);
        authyOk = JSON.parse(authyOk);
        $("#verify_email_form").hide();
        $("#verify_token_form").show(); // SHOW VERIFY TOKEN FIELD
        var value = $("#email").val();
        $("h4").text("currently reseting password for " + value);
      } else {
        var error = JSON.stringify(msg.response.error);
        error = JSON.parse(error);
        if ($("#email").val() === "") {
          error = "please enter your plynty account email first to continue";
        } else {
          if (error === "no account for this email") {
            error = "no account was found for this email, please try a different email";
          }
        }
        $("#email_error").show();
        $("#email_error").text(error);
      }
    });

    request.fail(function (jqXHR, textStatus) {
      // alert("Request failed: " + textStatus +' '+ jqXHR.status);
      var error = "hmm.. there was an issue connecting. please try again"
      $("#email_error").show();
      $("#email_error").text(error);
    });

    return false;

  });
</script>
<script>
  var tokenInfo = {};
  $("#verify_token_form").submit(function (event) {
    tokenInfo.email = $('#email').val();
    tokenInfo.authyToken = $('#token').val();
    var request1 = $.ajax({
      url: "https://dev.plynty.com/api/users/verifyToken",
      data: tokenInfo,
      contentType: "application/json; charset=utf-8"
    });

    request1.done(function (msg) {
      if (!JSON.stringify(msg.response.error)) {
        $("#verify_token_form").hide();
        $("#password_change").show();
      } else { // on fail
        var error = JSON.stringify(msg.response.error);
        error = JSON.parse(error);
        if ($("#token").val() === "") {
          error = "please enter the token that was texted to you";
        }
        $("#token_error").show();
        $("#token_error").text(error);
      }
    });

    request1.fail(function (jqXHR, textStatus) {
      // alert("Request failed: " + textStatus +' '+ jqXHR.status);
      var error = "please enter a valid token";
      $("#token_error").show();
      $("#token_error").text(error);
    });

    return false;

  });
</script>
<script>
  $("#password_change").submit(function (event) {
    var updatePwd = {
      access_token: accessToken
    };
    updatePwd.authyToken = $('#token').val();
    updatePwd.password = $('#password').val();
    var request2 = $.ajax({
      type: "POST",
      url: "https://dev.plynty.com/api/users/updatePassword?access_token=" + accessToken,
      data: updatePwd
    });

    request2.done(function (msg) {
        $("")
        $("#password_change").hide();
        $("#success").show();
        $("h1").hide();
    });

    request2.fail(function (jqXHR, textStatus) {
      // alert("Request failed: " + textStatus +' '+ jqXHR.status);
      checkEmpty();
      function checkEmpty() {
        if ($("#password").val() === "") {
          var error = "please entered the desired password";
          $("#password_error").show();
          $("#password_error").text(error);
        } else {
          comparePassword();
        }
      }

      function comparePassword() {
        if ($('#password').val() !== $('#password_confirm').val()) {
          var error = "please make sure both passwords are same";
          $("#password_error").show();
          $("#password_error").text(error);
        } else {
          connectionError();
        }
      }

      function connectionError() {
        var error = "please go back to the application and request for a password reset again";
        $("#password_error").show();
        $("#password_error").text(error);
      }
    });
    return false;
  });
</script>